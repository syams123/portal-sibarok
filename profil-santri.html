<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Santri - Si Barok</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Poppins', sans-serif; }
        .profile-header {
            background: linear-gradient(135deg, #198754 0%, #28a745 100%);
            height: 200px;
            border-bottom-left-radius: 50% 20%;
            border-bottom-right-radius: 50% 20%;
        }
        .profile-card { margin-top: -100px; border-radius: 20px; border: none; }
        .avatar-lg { width: 120px; height: 120px; object-fit: cover; border: 5px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .italic { font-style: italic; }
    </style>
</head>
<body>

<div class="profile-header"></div>

<div class="container mb-5">
    <div class="card profile-card shadow-sm mx-auto" style="max-width: 500px;">
        <div class="card-body text-center p-4">
            <p class="text-muted mb-3" style="font-size: 0.8rem; letter-spacing: 1px; font-weight: 600;">
                KARTU DIGITAL - NIS. <span id="viewNIS" class="text-dark">........</span>
            </p>
            
            <img id="viewPhoto" src="https://via.placeholder.com/150" class="rounded-circle avatar-lg mb-3">
            <h3 id="viewName" class="fw-bold mb-1 text-uppercase text-dark">Memuat...</h3>
            <p class="text-success fw-bold small">TPQ Al-Mubarok ARC BB03-09</p>
            
            <hr class="opacity-10">
            
            <div class="row text-start mt-4">
                <div class="col-6 mb-3">
                    <small class="text-muted d-block" style="font-size: 0.7rem;">Status Belajar</small>
                    <span id="viewJilid" class="fw-bold text-dark">Jilid -</span>
                </div>
                <div class="col-6 mb-3 text-end">
                    <small class="text-muted d-block" style="font-size: 0.7rem;">Target Utama</small>
                    <span class="fw-bold text-dark text-success">Al-Qur'an</span>
                </div>
            </div>

            <div class="mt-3 text-start">
                <label class="d-flex justify-content-between small mb-1">
                    <span class="text-muted" style="font-size: 0.75rem;">Progres Belajar</span>
                    <span id="progressText" class="fw-bold text-success">0%</span>
                </label>
                <div class="progress" style="height: 12px; border-radius: 10px; background-color: #e9ecef;">
                    <div id="viewProgress" class="progress-bar bg-success progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                </div>
            </div>

            <div class="mt-5 p-3 bg-light rounded-3 italic">
                <p class="small text-muted mb-0" style="line-height: 1.6;">
                    "Sebaik-baik kalian adalah yang mempelajari Al-Qur'an dan mengajarkannya." <br><strong>(HR. Bukhari)</strong>
                </p>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDfQEHk44JiV4mGQjOHcyyDBgp0dSqfkBE",
        authDomain: "tpq-al-mubarok.firebaseapp.com",
        projectId: "tpq-al-mubarok",
        storageBucket: "tpq-al-mubarok.firebasestorage.app",
        messagingSenderId: "169834752758",
        appId: "1:169834752758:web:a249231849f9c32a73dad7",
        measurementId: "G-57HT9Y0VMT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- PERBAIKAN: Ambil NIS dari URL (Sesuai dengan QR Code) ---
    const urlParams = new URLSearchParams(window.location.search);
    const nisSantri = urlParams.get('nis');

    async function loadProfil() {
        if (!nisSantri) {
            document.getElementById('viewName').innerText = "Link Tidak Valid";
            return;
        }

        try {
            // --- PERBAIKAN: Cari berdasarkan NIS agar lebih akurat ---
            const q = query(collection(db, "students"), where("nis", "==", nisSantri));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const data = querySnapshot.docs[0].data();

                // 1. Update Teks Identitas
                document.getElementById('viewName').innerText = data.name;
                document.getElementById('viewNIS').innerText = data.nis || "-";
                
                // 2. Logika Jilid & Progress (Sama dengan Dashboard Wali)
                let jilidRaw = data.jilid || "Jilid PAUD";
                let jilidClean = jilidRaw.replace("Jilid ", "");
                document.getElementById('viewJilid').innerText = jilidRaw.includes("Jilid") ? jilidRaw : "Jilid " + jilidRaw;

                let numericJilid;
                if (jilidClean === "PAUD") numericJilid = 0.5;
                else if (jilidClean.includes("Qur")) numericJilid = 6;
                else numericJilid = parseInt(jilidClean) || 0;

                const progress = Math.min((numericJilid / 6) * 100, 100);
                
                // 3. Update Visual Progress
                document.getElementById('viewProgress').style.width = progress + "%";
                document.getElementById('progressText').innerText = Math.round(progress) + "%";

                // 4. Update Foto/Avatar
                const avatar = data.gender === 'Perempuan' ? 'https://i.imgur.com/NcNQ9R3.jpeg' : 'https://i.imgur.com/HPPr16Q.jpeg';
                document.getElementById('viewPhoto').src = data.photo || avatar;

            } else {
                document.getElementById('viewName').innerText = "Data Tidak Ditemukan";
                alert("Maaf, data santri dengan NIS tersebut tidak ditemukan.");
            }
        } catch (error) {
            console.error("Error loading profile:", error);
            document.getElementById('viewName').innerText = "Gagal Memuat Data";
        }
    }

    loadProfil();
</script>

</body>
</html>